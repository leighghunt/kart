import pytest

from kart import is_windows, is_linux
from kart.sqlalchemy.sqlite import sqlite_engine
from sqlalchemy.orm import sessionmaker

H = pytest.helpers.helpers()

SKIP_REASON = "s2_py is not yet included in the kart windows build"


@pytest.mark.skipif(is_windows, reason=SKIP_REASON)
def test_index_points_all(data_archive, cli_runner):
    # Indexing --all should give the same results every time.
    # For points, every point should have only one long S2 cell token.
    with data_archive("points.tgz") as repo_path:
        r = cli_runner.invoke(["spatial-tree", "index"])
        assert r.exit_code == 0, r.stderr

        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2148
        assert stats.avg_s2_tokens_per_feature == 13.0
        assert stats.avg_s2_token_length == pytest.approx(6.231, abs=0.001)
        assert stats.distinct_s2_tokens == 10980


@pytest.mark.skipif(is_windows, reason=SKIP_REASON)
def test_index_points_commit_by_commit(data_archive, cli_runner):
    # Indexing one commit at a time should get the same results as indexing --all.
    with data_archive("points.tgz") as repo_path:
        r = cli_runner.invoke(["spatial-tree", "index", H.POINTS.HEAD1_SHA])
        assert r.exit_code == 0, r.stderr
        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2143

        r = cli_runner.invoke(["spatial-tree", "index", H.POINTS.HEAD_SHA])
        assert r.exit_code == 0, r.stderr

        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2148
        assert stats.avg_s2_tokens_per_feature == 13.0
        assert stats.avg_s2_token_length == pytest.approx(6.231, abs=0.001)
        assert stats.distinct_s2_tokens == 10980


@pytest.mark.skipif(is_windows, reason=SKIP_REASON)
def test_index_points_idempotent(data_archive, cli_runner):
    # Indexing the commits one at a time and then indexing all commits again will also give the same result.
    # (We force everything to be indexed twice by deleting the record of whats been indexed).
    with data_archive("points.tgz") as repo_path:
        r = cli_runner.invoke(["spatial-tree", "index", H.POINTS.HEAD1_SHA])
        assert r.exit_code == 0, r.stderr
        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2143

        r = cli_runner.invoke(["spatial-tree", "index", H.POINTS.HEAD_SHA])
        assert r.exit_code == 0, r.stderr
        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2148

        # Trying to reindex shouldn't do anything since we remember where we are up to.
        r = cli_runner.invoke(["spatial-tree", "index"])
        assert r.exit_code == 0, r.stderr
        assert "Nothing to do" in r.stdout
        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2148

        # Force reindex by deleting record of what's been indexed.
        # Even so, this should just rewrite the same index over the top of the old one.
        db_path = repo_path / ".kart" / "s2_index.db"
        engine = sqlite_engine(db_path)
        with sessionmaker(bind=engine)() as sess:
            sess.execute("DELETE FROM commits;")

        r = cli_runner.invoke(["spatial-tree", "index"])
        assert r.exit_code == 0, r.stderr
        assert "Nothing to do" not in r.stdout
        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 2148
        assert stats.avg_s2_tokens_per_feature == 13.0
        assert stats.avg_s2_token_length == pytest.approx(6.231, abs=0.001)
        assert stats.distinct_s2_tokens == 10980


EXPECTED = [
    'Indexing from the very start up to 3f7166e ...',
    '4714af150c21d06deb5a5bf5f3c3b21d0dda3416: [175.3503192167, -37.8677371333, 175.3843470333, -37.8270649667]',
    '9149a1d4e7f551546d1a111fa9a1833acd9c4064: [174.2105324333, -39.1160069167, 174.2489834333, -39.0435761833]',
    '820bab4950c93743e9f47e183ebc6b533c3f4b17: [174.7304707167, -36.79928385, 174.73656865, -36.7941665]',
    'e7d14bacb091809902f7c6940f3d0993085cbe26: [175.9372281833, -37.42045365, 175.9457404667, -37.4103752833]',
    '22711ebda10ee3f81151862d629e025a2ae94b4d: [173.8122169833, -41.4864122833, 173.87720895, -41.4583918833]',
    'a30111c210ea06f056432301d099ba407207c03d: [173.9169293667, -41.4844708167, 173.9647693, -41.4395852833]',
    'c50eb0cb465c86caa3d83ba608c1e5885f6e5b16: [175.296774, -37.7878993833, 175.3042415333, -37.78003745]',
    '69e87841cf7adf2adad8e0230738576924efb73a: [175.33535455, -37.7838764, 175.3890286167, -37.7436952]',
    '10590ac86846e07be505dd20221be25ec1f5c6df: [175.9572580333, -37.45032065, 175.9690364, -37.4439742667]',
    'e0673362470d88b966a35162e859e2837ab95742: [176.2744227333, -38.1397267833, 176.2957355833, -38.12307375]',
    '299fcb10206313b12ef28d2029d56b449a495994: [174.8775472833, -37.80280005, 174.8871900833, -37.79600595]',
    'cc9d3bf68e1957332a157b0cf10af3faceb5389a: [175.85212375, -37.23610165, 175.8720091, -37.21652395]',
    'e8db0b6357bca504cf05b4beab4977d9b42cdfd3: [173.9643716167, -41.4968959, 174.0018425167, -41.470688]',
    '1eb70f9424e7d0463d2d2bbea90c572090fba00c: [175.28535185, -37.7391772833, 175.38519405, -37.67888735]',
    'c558c4ba92017a1bc3ff2b163b91da9fe9cb10c4: [176.07148405, -38.7410916167, 176.1530528333, -38.70368375]',
    'f3821b84773c1c5360cc52c71ba0e6601a618a61: [175.14444885, -37.6619834, 175.1563347, -37.6476698667]',
    '8b107b621f25d0b2204e869e551dda4795072cda: [176.3457951, -37.8199576333, 176.3768728333, -37.79414425]',
    '983ff4f1dfa0420f477e0ce438d28a4846c84cbf: [175.1525941667, -37.8327480833, 175.18798455, -37.79764915]',
    '7367d4556ca4236b415cbd2bd4585d851452ec37: [176.0063083167, -38.7106319833, 176.0306125167, -38.7026556667]',
    '8a2dd786e6b29cabff3a78821b9c38adcd395766: [173.8722426833, -41.5517880833, 173.9158666, -41.51007285]',
    'bf46dc3182ccd82010082175af7ff8f37263ff49: [175.9794702833, -38.7108684, 176.03101255, -38.68759225]',
    'f1d0d1d26e255457a0f5a2c2fb0c11568bac397b: [175.1732921833, -37.9028147333, 175.205864, -37.8723324]',
    'fcd0e22b3bb366f80aad64140828d8e77ba31d4c: [175.1079315333, -41.1268976667, 175.1433897167, -41.1074664667]',
    'f2a67e06f3661507ff2538c8e7fa4e8b8e14178c: [175.4510755667, -37.8462119167, 175.5085503167, -37.77884775]',
    'd06108f722a826fcfbcc075bf3de20fb115d0ab9: [174.8109157333, -41.3150332833, 174.8199542833, -41.3088407833]',
    'ff12ecb7d7589f0cb7e8c61e002ee426266980f9: [175.4016415333, -37.7881351167, 175.4634474167, -37.7352059833]',
    'e5f6767cb8a254cb7c36a80b3da1828d485db6b3: [175.7831262, -37.4127584333, 175.8275354167, -37.3739932167]',
    '39a3af3c9f9b70507216fb5655d5305437e12f41: [175.08519385, -41.15746445, 175.1187181333, -41.1153914]',
    '89ada7686b5424218364a3333e827d6d052d9e37: [175.3995904, -37.8248700167, 175.4648245833, -37.7823901167]',
    '86e8b1c29fea66527ec96f1538c02a5d79817649: [175.1725777667, -37.7007798, 175.21792855, -37.6676027833]',
    '5c358ec7740cc17b4b10e6b3886ccc1c1f02fc1f: [175.8204363833, -37.4053268333, 175.8400996833, -37.3952018667]',
    '045080622b5a75e66cfa37472f78f9abf4b35368: [174.7864396833, -41.2521621333, 174.7938725833, -41.2476486833]',
    '44d00bdd9019bd761c9349627097b684123021b0: [175.8256414167, -37.3975900167, 175.8315888, -37.3881632167]',
    '506a0c7300c9e657742e3751dd568939ef986574: [175.8195078167, -37.3896987167, 175.8381654, -37.37575045]',
    '09423bc53b197e471cec238c99d047aa5f6c1b64: [175.27559905, -37.8649581667, 175.3071563, -37.8248757167]',
    '038279e526e8c2a75ba2acec44d4def7066ebd80: [175.8304632333, -37.3858704333, 175.8538254167, -37.3618301333]',
    '97554fc30d59f167c4954a0d6f316ca35e74db0a: [175.8303664167, -37.3896987167, 175.8381687667, -37.38386685]',
    'bcdb668275abdfc5ec337082dd8b40fd944d40f9: [175.833324, -37.3950541167, 175.8418636833, -37.3912871833]',
    '97968b1af82a3b6b8c7045468136cf14cb269e43: [174.8194222833, -41.3248908667, 174.8245942167, -41.3172966333]',
    '874716b99ef8a9891dfd7e250e5d2db8b659356c: [175.8406560333, -37.3965054167, 175.8497831333, -37.3915022167]',
    'd73a18e24683fc085d4d114b4a7ef6731c372bee: [175.41523025, -37.8456223833, 175.4538149667, -37.80290195]',
    'd6a0b934cdd8d32f5df135cfcd3c575301d70c0c: [174.9059835833, -41.2746698333, 174.9236335333, -41.26232135]',
    '3663823574c3af201bfe2cb1e22053d117577eb2: [174.7782178333, -41.2646764167, 174.7875835667, -41.2584270333]',
    '471fffa702c8dafe3ced7767c0b128860fbb36d8: [175.8486747, -37.38473885, 175.8728053333, -37.3730084833]',
    'c96d9d1ca3c36cde9d4fa3a3fdc14047cf475d08: [175.3635266167, -37.8368783, 175.4157425667, -37.81226835]',
    'e51d73b1321554c50fc98a189c3d1bbe4273fe0d: [176.1992924, -38.0835235333, 176.2128908333, -38.0780145333]',
    '4d6aae83e0018e315c02059097ddacd2f602c8cb: [176.2076637333, -38.0756762, 176.2164603667, -38.07006455]',
    '2edbb529dac48d810da476f198d1ce8c1648e537: [175.5564391333, -37.1589322667, 175.5997398, -37.1370994833]',
    'e90268c3036c4fd896abc2cacdff3ee1da165c3e: [176.9813236833, -37.9539493, 176.9867676667, -37.9486163167]',
    'ad9512b11f524e36237128fedd58f9ef71d07063: [176.9596254, -37.9562863, 176.9860495833, -37.9372666]',
    '16dd3ab6f02f84ed00f5e4d82c0744fd2fb9f2e8: [174.8401132333, -36.85955915, 174.8470411333, -36.85292]',
    'dcefe8ad72fc620d5c71e6c4ab41e71b3046362a: [174.6256437333, -36.7171435167, 174.6674544333, -36.6965681667]',
    '1c18f3ba4de7b4eece1e05027638ad858825b963: [175.0622809, -40.9059559667, 175.1153065667, -40.8777194]',
    '5877826bf22cdca523353e38842d5c67749568ce: [175.3496619833, -37.86780285, 175.3843470333, -37.8277652167]',
    '8c4b178c2268b2a05ce31c14bbe2ff7a5e404c73: [175.3012926, -37.9288664333, 175.3102881167, -37.9153488833]',
    'b81047cc5366f6aeb79ccaf5a867c3dcde0c835f: [175.2883021333, -37.7701331833, 175.3753402667, -37.70890695]',
    '19eadf74c73e7e516d36f2501f169e7aa37e3b29: [174.8335791667, -36.87023785, 174.8456191667, -36.8605727833]',
    '98b35abdd1540ff7b3081834dd4aaca287a39999: [174.7832560333, -36.81900165, 174.7945947667, -36.8148951167]',
    '2c97fb22651f893c353ca6af4405fe390867f7fc: [175.2593019833, -37.93625065, 175.3165794167, -37.8937535]',
    'd6099b546462b7dd75d0e82fce9ae28f32193dfa: [174.7196258, -36.74857315, 174.7375409333, -36.73490145]',
    'e290eb3c65fdec0658f8d211315fe36ae2fec4c5: [174.7269999833, -36.74332145, 174.7422271833, -36.7345195833]',
    '830f9db64a55177b1d3ab40ce220926c6af6dcc9: [175.14441105, -37.7149940833, 175.1916481333, -37.6848128667]',
    'edef09db6380bc21125064c6d230880d07ae1797: [174.7168802667, -36.73914865, 174.7340341667, -36.72967155]',
    'b30fdc9bdda6bb22630762252e73ee50568de0d0: [174.7322502, -36.7282838333, 174.7414819667, -36.7233794167]',
    'bc77b381488360aeca2f262880ec4b68795b6c51: [175.3699085833, -37.8054741, 175.4118005333, -37.7789328667]',
    'b450ddbb96bb8e50eb704822f510cb74a810cf87: [174.6389272, -36.6914270667, 174.68486435, -36.6704445167]',
    '0563f5e28dbcb600c111f9b210d8928d5dfd5729: [174.7904478167, -36.62933765, 174.80686285, -36.6122586833]',
    '6b6a46ee1e40c18c75ced58f6253f0b66f7b588f: [175.1353293167, -40.7929472833, 175.1767921, -40.7636445]',
    '28e86ead20ff9a5daf867648b4d1fda125b6d9e4: [174.5951035167, -36.71236795, 174.65132635, -36.6743243333]',
    '22233511c26bc7795d94ec08a69352a3915b674f: [175.1666594333, -37.8127831667, 175.20640805, -37.7912326333]',
    '061eb3db3cb539368f18c58c60bea196d711dc06: [174.56839175, -36.6869479667, 174.6387919833, -36.6453787]',
    '2dc31e44d5138ff265cb96f67198d2566a970161: [175.1674143167, -37.7032065833, 175.2064680167, -37.6804427]',
    '2571d6405167d54582cf4fa65486673269dfe071: [175.4235007333, -37.8092873833, 175.4720994667, -37.76217545]',
    '18d954d87aa788e91a09d35c5390a14fc9325edf: [174.6533004667, -36.5983472167, 174.68157775, -36.5710482667]',
    '90593412e8bcc7650646187277364ccf559dd515: [175.3476212, -37.88343635, 175.4095894, -37.8374234167]',
    '7894f0320bd9378dc761170190f81d778e900f1e: [175.1743259167, -37.8327480833, 175.2255310667, -37.8051188833]',
    '470f76887e4861704b4c32cf7c2014b69126cdd0: [174.68759415, -36.6165270667, 174.7044103167, -36.60507595]',
    '23aa530c3b009f3aa855acaef5c68dda66376e79: [174.7033422833, -36.6411259167, 174.7177654, -36.62643755]',
    'e9464849e13c379f54740c93b2186e513e1abb10: [174.7793005667, -36.6246571667, 174.7969935333, -36.61395215]',
    '1483af0b61d639d47e2f1471e141ac8490cb0dc6: [175.1151498333, -40.7435664333, 175.1236355667, -40.7357291167]',
    '6f8745edbde382056fd02dc424c6e66deddae068: [175.2754142, -40.6869671167, 175.3202816667, -40.6558711667]',
    '8b73f031cba2a0fa6ed00f1d5890248e93b4b5a6: [173.8851562667, -41.47208445, 173.9271529, -41.4437713833]',
    '6d905b3891500a7c3db8d2fb4962fdecb70e8b33: [173.9011952167, -41.49991365, 173.9350735, -41.4650408333]',
    'c5330b16ce4d34934425baa3cf04130a50b70705: [175.3155678667, -37.8772444833, 175.34979605, -37.8394517833]',
    'bf14e03d2383beace83e352c01d8d80f6946d5cc: [175.4501371167, -37.8710968333, 175.5413314833, -37.8166847]',
    'c8b82ca37933939ac4ce84e1bc64dffb705e6743: [175.2138845167, -40.6542677667, 175.2691537833, -40.6214541]',
    'bd4e02603e80b53f502754dfea5d599a649585c8: [175.48455125, -37.8867476667, 175.5433702667, -37.8602288333]',
    'da9d9b09826dbbfb5f895772ed50f99133aed406: [175.1228336167, -37.81649125, 175.145195, -37.8037201833]',
    'f49da7722dfe0a6148ae6c9fe114247b61bd1597: [175.3763444, -37.876733, 175.4391658, -37.8439139833]',
    'c5c99d72f2544ab844d03920152f050bd66759d0: [175.1501624833, -37.7978370333, 175.1908765667, -37.7572869]',
    '8adc32caa42033700ba6c24bd72620cf44f28354: [175.18442555, -37.692802, 175.2391676, -37.6215125]',
    '51f2b4dc35d627271972227263da6db59c81e9b4: [175.6319888333, -40.35864345, 175.6369122, -40.3528927833]',
    '7f70bd4ccf88ad4a0bdc66815f0761acddde25f3: [173.73044705, -41.5431518, 173.8110033167, -41.4829318333]',
    'ad5cd692f370ef2fa593eae2d20b0aa1cc1774da: [175.5379774333, -40.3449866167, 175.59111945, -40.2956832167]',
    'b6334332c2b4cd086aac56326e92ef3b88621608: [175.1779921333, -37.77427405, 175.21512155, -37.7420770667]',
    '9a80f42c61469091af4ca9c643884616cd70b4ce: [175.14839025, -37.6783527, 175.2038170833, -37.62494695]',
    '985dbce72304712c88356f0c1b18bd8f36b0d503: [175.6088096333, -40.4215186667, 175.6541158333, -40.3872978167]',
    '9a055350235f66191260094d7941e2be17c642dd: [174.8153374667, -37.2180109, 174.8573493, -37.19142105]',
    'd95882a8560be797444d6a42f9094dda8095e761: [175.6010809333, -40.3288295833, 175.63246695, -40.3045195333]',
    '983f48de4f26123e324456f8d1c08c139e26948b: [175.3844806667, -37.8281473167, 175.42658245, -37.7995250333]',
    '6b1c8b646a9e2824d103fe66be6751a9abaafa84: [174.8429648167, -36.9899496667, 174.84769855, -36.9862499667]',
    '97f5db9c0090499e24d3d374fe6a6e69a64ca820: [175.3844806667, -37.8281473167, 175.42658245, -37.7995250333]',
    'fa6b0d3d2d9da0f261be32f177a75386cd911cba: [175.4084016833, -37.8455587833, 175.4479976167, -37.81699965]',
    'af0da3d7cf1e76868400c2eb8a18b7458e3cdc44: [175.32562885, -37.9981248167, 175.3606574667, -37.9686627333]',
    '48646a548c5d173206cd4247daabb056290552a3: [175.6426193333, -40.3429848833, 175.6598677833, -40.3274551833]',
    '091f9ccc1cc2d610edc9fdff295689eeb19f4e9f: [174.9156313333, -36.95030615, 174.9284666833, -36.9398217667]',
    '60d45fbdfcad43017978fdf21da1de8713c91e80: [174.7787844667, -36.9886284833, 174.7902792, -36.9722122]',
    '6a4552ec1e2cbb1f8d144e06248522bd676b3095: [175.4235123833, -37.9065396667, 175.4730205333, -37.8954530667]',
    'bd69de8e976de66b2c8b6835eb44bd5d4dcffdc0: [175.2764476333, -37.98553115, 175.3346944667, -37.9262386833]',
    '8c11b93458cc1357723a62f52e3c65c9fdd78914: [175.3321007167, -37.8059169167, 175.3712013667, -37.7821699]',
    '0299357eda50165abaec3c59b34334a02d4edbc6: [175.3581076167, -37.8013959833, 175.38388545, -37.7817686333]',
    'd05786a25785976dc06ea4ebe81c92eb7118c262: [176.4116342833, -37.8248479, 176.4368778333, -37.8122710167]',
    '72064fb94e94387361f2cd9a962bf661677c52f3: [175.2259383833, -37.9722893833, 175.29480775, -37.9188078333]',
    'deff7bd516dc08a31402013fb2808b0c179ef139: [174.46126295, -36.7006004, 174.48129635, -36.6802235667]',
    'be5ba19145f25f6afd843196a86839669b6de651: [175.3573691833, -37.8457461667, 175.3970929833, -37.8243700667]',
    'a1a3e4a49bcefeb77e65308db95c12a708ee4f36: [175.3409005667, -37.8248955167, 175.3710861, -37.8012997667]',
    'f6806669a8b2c4b61c1a4db6ca67979748b91520: [175.2122365333, -37.9138297333, 175.3247368833, -37.8519895833]',
    'f001035f85d79235e24f619e36c4e98323860e9c: [175.3681555833, -37.81382115, 175.3958971, -37.8002316833]',
    'b8a2aed7d91fa91ad5aea47e3d0dea38027a4266: [174.2736771, -35.7061851167, 174.2989529333, -35.6890691833]',
    '0b7dbcfb767bba03cbf78002db46720d0d007145: [175.3634477, -37.82630355, 175.3844874333, -37.81226835]',
    '13ceecb545177ac9f662e2fefcd1168f6ac0d91e: [175.0663875667, -37.9328759833, 175.1348449333, -37.8850609167]',
    '46a8ef3bad7832e58c4c072bf75d2d9b99d39d9b: [174.8276645667, -37.2496237333, 174.86918165, -37.2113528833]',
    '92d95249f47964182724372bf3bb3341276561b7: [175.3930447833, -37.8481427167, 175.4479976167, -37.8354331667]',
    '53a5c73c41dbfc8e56b244675e979b1830e6e081: [175.0864645, -37.9645097667, 175.1479795, -37.9172042667]',
    'c150c29a1606f9b3d6ad572d7f4bdf5352cc0d70: [175.17343175, -37.93850625, 175.3065774333, -37.8981483833]',
    '94c134a13e1fdddc955db9de198006d91ff846df: [175.95665205, -37.65242025, 175.98877695, -37.6241768667]',
    '3c3ec55bec8d2bd831273ab3fc56b4ba427d7552: [174.9389714667, -37.1650110833, 174.9656591667, -37.1380369333]',
    '7ab85dbc6515e011fb6f6f434907ced2aaaf194f: [175.1282141667, -37.9690064, 175.1844268667, -37.9011220167]',
    '1f0d66b348cd276ba2ad8b5070b8a5f81e394328: [175.1976405667, -37.8094923, 175.2345791833, -37.7932027167]',
    '7a2e0ac2d8ea3ef030a2ed54bef4d0e7155c79d9: [174.5662840833, -36.1322040833, 174.5806837333, -36.1238926]',
    '1ac3b15722b9264ef33b4e36bc42267be499e64e: [174.80187245, -37.8271119, 174.8223793167, -37.8210347333]',
    '06474246a8b3781e576c22b84358bb58dc391fec: [172.3831761833, -43.60031975, 172.3938820833, -43.5962569833]',
    'e4807e7bc49979c5286c764a073eb4e1f7e87673: [172.5813876, -43.3196066167, 172.5902181333, -43.3124735]',
    '6154ee8487ba23f0cd87783787c1d2663c9a6634: [172.5919891667, -43.3184761667, 172.5989126833, -43.3132863333]',
    '2ac55e91f4fcec70a8dda6229e186bf1f01ae2cf: [172.5769990333, -43.2977346833, 172.5845080667, -43.2930959667]',
    '16588124356deeffaec2114e06d804d9e237398c: [172.58956885, -43.3155617833, 172.5948232, -43.3113330167]',
    'ee437691720d98fbc9fde19a693709f58338bccc: [172.5925847, -43.2966227, 172.5987042833, -43.29124595]',
    'd3e844e83641c26bffa0bf7008873d960b2fb516: [172.5832755333, -43.3324846167, 172.5988311167, -43.3179535333]',
    '0e5766333aac93e70b036876e2d5d111493bab11: [172.5850753333, -43.29613285, 172.59572805, -43.2917320667]',
    '93da6a65ff194dabc36417adaaafd033b0e787fb: [172.57708075, -43.30547275, 172.58736585, -43.3018199667]',
    '9d01f317750849aca5fa4cbb97d0c6a5d661d973: [172.5885206333, -43.3188206667, 172.5947428667, -43.3142727]',
    'c8d0f1b0de7978a484f3a22b110556556ba37c93: [172.5960604, -43.3181732833, 172.6120470167, -43.3017935667]',
    '5c9b0a0808b36875f0c85ba192764502abfef387: [172.5827751833, -43.30444935, 172.59097825, -43.2970689167]',
    'eabad71d9b2c93252a9bd13a85380b77fed26346: [172.58160385, -43.2928680833, 172.5950502167, -43.2884260667]',
    '0fecdf84020fe52c31663cc9443793281ae6b218: [172.58912555, -43.30410465, 172.5957678167, -43.29788645]',
    'd778d5668fe153c316834dde9f488283246cc5cf: [172.5812641167, -43.3150920833, 172.5909609167, -43.31157305]',
    'f2e9559d64fb933b30f960e5ead744baae478b83: [172.5903321333, -43.3121930667, 172.5986270167, -43.3076321833]',
    '88d6e2e99eb46c483300e32ef3f6f94143f060f2: [172.5940125, -43.3035271167, 172.60050535, -43.2952935]',
    '627ba713aad361a7b3a3791174994ab1f7dfdde2: [172.5784203167, -43.3037711, 172.5868725833, -43.2999407667]',
    'd8c983cf5eefc28a8fd2f4ee91e06e24fff895ae: [172.5792184167, -43.3128242833, 172.5871222833, -43.3062228]',
    'e09dab82601427a38936ec1f0f42fb68e9b534f7: [172.5794507667, -43.3079322167, 172.5863600167, -43.3042038167]',
    'fdc0241b290d72dec2baa0b901eb0cd10b6ceb97: [172.5835389333, -43.3122609833, 172.5907224167, -43.3042291333]',
    '06c58a40a12fac6969110b0b42d2424be2112df9: [172.5908250667, -43.3032616167, 172.5968166333, -43.2950775333]',
    'c7e146966bf5a055d705fa9a49f26a1584bab21b: [172.5758387, -43.2966967333, 172.5908712667, -43.2894036667]',
    'f38af719336cbc8495d2c4f27ff85ffd31847171: [172.5890347667, -43.3095629167, 172.5946961, -43.3034917]',
    '6c2667ef0c2594e36d78589f11a26b9bce59b8d7: [172.5886696833, -43.3020124833, 172.5932592167, -43.2950775333]',
    'ff7dacd17bc855fdb29873dc25f5c3853bdfcf7f: [172.5777264167, -43.3007339833, 172.5845793667, -43.2968427333]',
    'a277bfc129f914d491c0f1b1d70e24bb8769d6dd: [172.5827751833, -43.3001748333, 172.5893862167, -43.2951593167]',
    'd24e86b94b10aa2e43aff85404f6563cb599e73b: [172.6563261667, -43.3787618167, 172.6649607833, -43.3530062667]',
    '5fd0b3f2f917cb0363a54357dca9b219bc059c63: [172.6588055667, -43.3242268167, 172.6659689167, -43.3202521667]',
    '3f79be7392d9e157e33c1b8a9faa4aec1557d347: [172.6658231, -43.3294962, 172.6766716333, -43.3256993833]',
    'ed8e766f30a34394ef65438bbc9fc9e6bda3b811: [172.6610253333, -43.3310973333, 172.6773600667, -43.32337105]',
    'd4a2970722a163f27b9985314811724de2fe6c9e: [172.6655357667, -43.3240717, 172.6792297, -43.3204327667]',
    'df20941989524aae57ff210c7cf3bd39ac268cfe: [172.5920376667, -43.30876255, 172.5981157167, -43.3029356]',
    '4dd518a2ac8404f1757bdc66050cd494cb186b6a: [172.5970424833, -43.3114387833, 172.60233815, -43.3026516]',
    'a611d6ca5f3a11b5c9cc5f5e5cd8b50071ab1a57: [172.6613822333, -43.3210356333, 172.6687351833, -43.3166494833]',
    '1ce513d69cc00fe084580b4341abf1beb74baa29: [172.6558639, -43.3205664667, 172.6651513833, -43.3158166667]',
    '5b44d449739b3fc64e2925ec9acff340117f86a3: [172.65698725, -43.3185564167, 172.6700281333, -43.3129334167]',
    'b9ac77ef382896510aa56332215d92d21abccf1f: [172.6404100667, -43.38570515, 172.6474328167, -43.3778258833]',
    '286c2931b518149431ad2770d705382b43fa8631: [172.64876285, -43.3781148833, 172.65726475, -43.3739555667]',
    '4d5f21ba0794833872ddf283b0ed2f5fe33850b9: [172.6323533333, -43.3791141833, 172.6538891833, -43.372461]',
    '3485b1646f3b42dd9bb45b22e4627a0c6ed85e60: [172.6349854, -43.3853065, 172.6438847167, -43.3744365667]',
    '3e20c49240e1351376dd7253778b81c7d29f3836: [172.72011095, -43.5991285833, 172.7446022667, -43.5829464]',
    '79fae59a5411cb30c112ef060c475a740a83895c: [172.7414841, -43.5957616667, 172.7583074, -43.5746865333]',
    'a2dd7696a2b5029f85434cacf90c492cc2a32886: [172.6404100667, -43.3867414833, 172.6493672833, -43.3791141833]',
    '2375abe411b29d09628aa6b1b42215ebacc9c3b9: [172.6462138333, -43.38723165, 172.6515853167, -43.3791141833]',
    '15501dd78d713bfc7e61d862b0bbc33cd35d3a7f: [172.7244412167, -43.5879768667, 172.7529028, -43.56736595]',
    'd140c0c8ff19d695e6bf9883f416bba60109b05a: [172.6354150833, -43.3936910667, 172.6447474, -43.384803]',
    '4f75681e9bf39d57ddf6b0d7313152d44e65c522: [172.6497863333, -43.3931089167, 172.6557286167, -43.3827443333]',
    '249bf7c02073849ce84560b1d9f8452ac5ed46a4: [172.7546476333, -43.5848520333, 172.7622314333, -43.5753242333]',
    'd88b30d968dfc7e0b1c16b24fc65caffb0a23920: [172.7575783, -43.5767213833, 172.7624719333, -43.5709382167]',
    'd7a20c434066fe2580c5bece157ece14106d07d7: [172.6424958167, -43.3918757333, 172.6514312667, -43.3863807167]',
    'ba73a2fca11ea08bd75f1f85218c0f8d25fdaa36: [172.6411461, -43.3961535667, 172.6523716, -43.3918306333]',
    'bdc3ea130167b1c584fd88f17be0a97704e99924: [172.7589297333, -43.5757564, 172.7649155, -43.5693785833]',
    'e05b5afa86d88f29edf6a15a737beae26866ff89: [172.6413145, -43.3947349333, 172.6503834167, -43.3905349833]',
    'b5eaf72f4d8dd9ee6637fecb17020ef39575abc6: [172.715083, -43.4862736833, 172.7233176333, -43.4753236167]',
    '5bb7abd0bf29ffb8392d269b0b622e6505cea4cc: [172.7154803667, -43.4846265, 172.72037545, -43.4775368333]',
    '40e0fe85e14243ee919f3da65719b16d625c804f: [172.7167274833, -43.48635265, 172.72250305, -43.48276845]',
    '2ac370c708457ac762b58ee14cc5def9e65406f0: [172.71596145, -43.4910068833, 172.7205192333, -43.4863195167]',
    '813c710e998cf7b349e8edc5fa44c3e247c5abc2: [172.7465702667, -43.5731991667, 172.7537755, -43.5666559667]',
    '8e6cd70e9051dfaa8ac210d35975358656fb5319: [172.7529962167, -43.5687080167, 172.7570810667, -43.5647988667]',
    'f5c7710c7e29051ebb5c2f19dce19f99b5088aef: [172.7452610333, -43.5675719333, 172.7546756833, -43.5636195333]',
    '5c954240f250b20e91fee07d63f5d90c6dd161cc: [172.7191846, -43.4903478167, 172.7242069167, -43.48624325]',
    '34b751d0edc0fa32cc3e865b9f5a6fd306a63399: [172.7684542333, -43.5796194333, 172.7751187667, -43.5727040667]',
    'ad6e2e01c53791b4a44fc01f883047167b52c40c: [172.7188473167, -43.4926781333, 172.7256198167, -43.4887423667]',
    'e84f35f41b22b9455b7d4a09421abf797c28bc46: [172.7680078833, -43.5760814, 172.7763111167, -43.5695937333]',
    '1bf9bb10123b0963187c4a8b73c151c0ff744cc4: [172.7730810667, -43.5850819333, 172.7784509833, -43.5695937333]',
    '5d8afab33ca8602e8aa7229ef16177af32c79bb9: [172.7208836333, -43.4951205, 172.7260947833, -43.4915410167]',
    'b35feea075f8bf28293b0d461ce1a4194aec6a5c: [172.71615645, -43.5074932167, 172.7253019, -43.4951154333]',
    'bbd2420243dbb87996c0d746f2048af2b9e17161: [172.7405707833, -43.5809939667, 172.7586455333, -43.5677851667]',
    'b4a41bd18a41ee88271191a537d1e0a27100b2a0: [172.7207676667, -43.5019304333, 172.7295969, -43.4926055167]',
    'caf37586bbfd5c8ec6d9f28a6a895e1554a9fed6: [172.6740638, -43.1532944167, 172.7306462333, -43.1141255]',
    '7b27afbcd8da7d6b2df504c8e0eb033d46cd1a04: [172.7205584, -43.5641546167, 172.7242438167, -43.5570781]',
    '3f6b01043f21bdbe0ac98b8c3e5e86522fb168d3: [172.7172634, -43.15983375, 172.72972985, -43.1518991333]',
    'cd49e5ee4f35e23e75f2fd1aa611f32237f009c0: [172.7278406333, -43.16048135, 172.7344743333, -43.1542933333]',
    '80960d093d89e5353df0fcc25a53e51deb1d0f39: [172.7227698833, -43.16725915, 172.73459735, -43.1583859333]',
    '1a38a5a886082a200b60709c22bb555860dfb321: [172.7294110833, -43.1502244667, 172.7405818833, -43.1453826167]',
    '6f37e30e9dea69afd0fcf2b44f080697d36e4d20: [172.7296701833, -43.1575781, 172.7434723333, -43.1498575]',
    'd0bb7a9325bdc2caf9e151ffb4377a8d6bbfe777: [172.3684112333, -43.5972291, 172.3806067667, -43.5906285333]',
    '0ab5782a49f48f6c3ad1be0816eb4d8eb4827949: [172.37897415, -43.5982276333, 172.3935694667, -43.5907899667]',
    '27ef6aec7e202697b9651bbd1911b50a49480fbb: [172.37897415, -43.5977057667, 172.3950830833, -43.5857967333]',
    '5aa247187a9c1893fc70d463793325fc5e12a876: [172.3933241833, -43.5971969667, 172.4101738833, -43.5818667833]',
    '5d1751486969d3bc0a87c666cced9ab4274e102d: [172.3923279, -43.5971969667, 172.4117104167, -43.58155885]',
    '091eb2f16039471a6cc15adb8ae1fd4218ec751d: [172.3195776167, -43.5900068667, 172.3853172333, -43.5541524333]',
    'a8dfb0747cf06ba6980cc93e7ca669afafd68f88: [172.3710157833, -43.5894094333, 172.4083192333, -43.5526500333]',
    '70c0d1ef7d5a394187c814728f47712f5a17dc8d: [172.36698165, -43.6003913333, 172.3866813833, -43.5927213333]',
    '4fde3161d95fbabe93117fed9093536a458278b9: [172.3851023667, -43.60031975, 172.3968041833, -43.5963522667]',
    '4d5cd00443de326d8d0383c876d042d30d3a9edf: [172.37897415, -43.5977057667, 172.3950830833, -43.5857967333]',
    '1e70c066889017e493649d8d18f11a56de241b20: [172.37897415, -43.5982276333, 172.3935694667, -43.5907899667]',
    '1f929e46940d2a5935decf0196ec6397fa625aef: [172.3933241833, -43.5971969667, 172.4101738833, -43.5818667833]',
    'f61e0a8a33d23635281e9aaa230e23844f76cb55: [172.3937291167, -43.6169740667, 172.46451575, -43.5793088833]',
    '17e30e913e7fa1b2543b580b1e4f767e9d8af09f: [172.3751842167, -43.6044313667, 172.38678045, -43.5966604667]',
    '81d32b4cd36a5406c8dc5c40df61156e50eb7ad4: [172.3521363333, -43.6117206667, 172.3669964333, -43.6000963167]',
    '04f5a8ee33959639d7a0df6e4b0d9fcb7e039f74: [172.3675491167, -43.6203472, 172.3867952167, -43.6006516833]',
    '251e4d50bee78d717c4c124550a27f220d400174: [172.35188315, -43.60702175, 172.3696231333, -43.59719555]',
    'd750270c3cf64a359a427e05a938c7c9dbe46a5d: [172.3606803333, -43.63304235, 172.3823639833, -43.609094]',
    '03f318186b6d7eef401c11465c443e7054e52123: [172.3692782833, -43.6357029833, 172.3986756333, -43.6133837667]',
    '0630c599b4cfdc759d4b664d41ca5af96377c552: [172.3638657167, -43.6088394333, 172.3779660833, -43.5984066333]',
    'Indexed 227 features in 0.1s',
]


@pytest.mark.skipif(is_windows, reason=SKIP_REASON)
def test_index_polygons_all(data_archive, cli_runner):
    # FIXME: These results shouldn't be different on macos and linux.
    # Dig into why they are different.
    with data_archive("polygons.tgz") as repo_path:
        r = cli_runner.invoke(["spatial-tree", "index"])
        assert r.exit_code == 0, r.stderr
        assert r.stdout.splitlines() == EXPECTED

        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 228
        assert stats.avg_s2_tokens_per_feature == pytest.approx(
            30.101 if is_linux else 30.075, abs=0.001
        )
        assert stats.avg_s2_token_length == pytest.approx(
            7.290 if is_linux else 7.292, abs=0.001
        )
        assert stats.distinct_s2_tokens == 3812 if is_linux else 3802


@pytest.mark.skipif(is_windows, reason=SKIP_REASON)
def test_index_table_all(data_archive, cli_runner):
    with data_archive("table.tgz") as repo_path:
        r = cli_runner.invoke(["spatial-tree", "index"])
        assert r.exit_code == 0, r.stderr

        stats = _get_spatial_tree_stats(repo_path)
        assert stats.features == 0
        assert stats.s2_tokens == 0


def _get_spatial_tree_stats(repo_path):
    class Stats:
        pass

    stats = Stats()

    db_path = repo_path / ".kart" / "s2_index.db"
    engine = sqlite_engine(db_path)
    with sessionmaker(bind=engine)() as sess:
        orphans = sess.execute(
            """
            SELECT blob_rowid FROM blob_tokens
            EXCEPT SELECT rowid FROM blobs;
            """
        )
        assert orphans.first() is None

        stats.features = sess.scalar("SELECT COUNT(*) FROM blobs;")
        stats.s2_tokens = sess.scalar("SELECT COUNT(*) FROM blob_tokens;")

        if stats.features:
            stats.avg_s2_tokens_per_feature = stats.s2_tokens / stats.features

        if stats.s2_tokens:
            stats.avg_s2_token_length = sess.scalar(
                "SELECT AVG(LENGTH(s2_token)) FROM blob_tokens;"
            )
            stats.distinct_s2_tokens = sess.scalar(
                "SELECT COUNT (DISTINCT s2_token) FROM blob_tokens;"
            )

    return stats
